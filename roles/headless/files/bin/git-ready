#!/bin/bash
set -e
BRANCH_NAME=${1:-$(name)}

# Preserve uncommitted changes, if there are any.
if ! git diff-index --quiet HEAD -- ; then
    git add -u
    git stash

    function restore_uncommitted_changes {
        git stash pop
    }
    trap restore_uncommitted_changes EXIT
fi

DEFAULT_BRANCH_NAME=$(sed -e 's/^.*\///' < $(git rev-parse --show-toplevel)/.git/refs/remotes/origin/HEAD)
echo "Identified the default branch as '$DEFAULT_BRANCH_NAME'"
git checkout $DEFAULT_BRANCH_NAME
try git pull

if [ ! -z "$BRANCH_NAME" ]; then
    if git show-branch "remotes/origin/$BRANCH_NAME" 2>&- && git show-ref --verify --quiet "refs/heads/$BRANCH_NAME" ; then
        echo 'WARNING: Branch exists both locally and upstream! Deleting local branch in favor of remote.'
        git branch -D $BRANCH_NAME
    fi

    if git show-ref --verify --quiet "refs/heads/$BRANCH_NAME" ; then
        # If the branch only exists locally, use it.
        echo "Rebasing local branch '$BRANCH_NAME' on latest '$DEFAULT_BRANCH_NAME'"
        git checkout $BRANCH_NAME
        git rebase $DEFAULT_BRANCH_NAME
    elif git show-branch "remotes/origin/$BRANCH_NAME" 2>&- ; then
        # If the branch only exists upstream, use it.
        echo "Rebasing remote branch '$BRANCH_NAME'"
        git checkout --track "origin/$BRANCH_NAME"
        git pull origin $BRANCH_NAME
        git rebase $DEFAULT_BRANCH_NAME
    else
        # Branch does not exist yet! Create it.
        echo "Creating a new local branch '$BRANCH_NAME'"
        git checkout -b $BRANCH_NAME
    fi
fi
